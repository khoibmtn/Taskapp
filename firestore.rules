rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPER FUNCTIONS ---
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Get user profile data from the SAME database the query is hitting
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function hasRole(role) {
      return isAuthenticated() && getUserData().get('role', '') == role;
    }

    // Check if user is personally involved in the task
    function isInvolvedInTask(taskData) {
      return isAuthenticated() && (
        (request.auth.uid in taskData.get('assigneeUids', [])) || 
        (taskData.get('assignees', {})[request.auth.uid] == true) ||
        (taskData.get('supervisorId', '') == request.auth.uid) ||
        (taskData.get('createdBy', '') == request.auth.uid)
      );
    }

    // --- COLLECTION: TASKS ---
    match /tasks/{taskId} {
      
      // ADMIN: Full access to everything
      allow read, write: if hasRole('admin');

      // MANAGER: Access to their department OR tasks they are involved in
      allow read: if hasRole('manager') && (
        (resource.data.get('departmentId', '') == getUserData().get('departmentId', '')) ||
        isInvolvedInTask(resource.data)
      );
      
      allow update: if hasRole('manager') && (
        (resource.data.get('departmentId', '') == getUserData().get('departmentId', '')) ||
        isInvolvedInTask(resource.data)
      );

      allow create: if hasRole('manager') && request.resource.data.get('departmentId', '') == getUserData().get('departmentId', '');

      // STAFF & ASIGNER: Only tasks they are involved in
      allow read: if (hasRole('staff') || hasRole('asigner')) && isInvolvedInTask(resource.data);
      
      allow update: if (hasRole('staff') || hasRole('asigner')) && isInvolvedInTask(resource.data) && (
        // Only allow updating approvals and updatedAt
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['approvals', 'updatedAt']) &&
        (
          !('approvals' in request.resource.data) || 
          request.resource.data.approvals.diff(resource.data.get('approvals', {})).affectedKeys().hasOnly([request.auth.uid])
        )
      );

      // ASIGNER can create tasks for their department
      allow create: if hasRole('asigner') && request.resource.data.get('departmentId', '') == getUserData().get('departmentId', '');
    }

    // --- OTHER COLLECTIONS ---
    
    match /users/{uid} {
      // Allow limited public queries for login lookup (max 1 result)
      allow list: if request.query.limit == 1;
      
      allow read: if isAuthenticated();
      allow write: if hasRole('admin') || request.auth.uid == uid;
    }
    
    match /departments/{deptId} {
      allow read: if isAuthenticated();
      allow write: if hasRole('admin');
    }

    match /notifications/{notifId} {
      allow read, update: if isAuthenticated() && resource.data.toUid == request.auth.uid;
    }
    
    match /{path=**} {
      allow read, write: if false;
    }
  }
}
